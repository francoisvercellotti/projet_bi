name: CI Workflow

on:
  push:
    branches:
      - main  # Cette action sera lancée à chaque push sur la branche 'main'
  pull_request:
    branches:
      - main  # Cette action sera lancée lors de la création de PR vers 'main'

jobs:
  test:
    runs-on: ubuntu-latest  # Le job s'exécute sur un runner Ubuntu

    steps:
      # Étape 1: Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Étape 2: Configurer Python et installer les dépendances
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'  # Spécifier la version Python souhaitée

      # Étape 3: Exporter les dépendances vers requirements.txt et installer avec uv
      - name: Export dependencies to requirements.txt using uv
        run: |
          uv export -o requirements.txt  # Exporte les dépendances dans requirements.txt
          uv pip install -r requirements.txt  # Installe les dépendances

      # Étape 4: Vérifier la présence du fichier de test
      - name: List files in bi_project
        run: |
          ls -al bi_project  # Liste les fichiers dans le répertoire 'bi_project'

      # Étape 5: Vérifier que pytest est installé
      - name: Check pytest version
        run: |
          source .venv/bin/activate  # Active l'environnement virtuel
          pytest --version  # Vérifie que pytest est installé

      # Étape 6: Lancer les tests avec pytest
      - name: Run tests with pytest
        run: |
          source .venv/bin/activate  # Active l'environnement virtuel
          pytest bi_project/test_environment.py --maxfail=1 --disable-warnings -v  # Lancer les tests dans le fichier spécifié

      # Étape 7: Vérifier le style de code avec flake8 (optionnel)
      - name: Lint code with ruff
        run: |
          source .venv/bin/activate
          ruff .  # Si ruff est installé, vérifie le style de code

      # Étape 8: Générer la documentation avec pdoc
      - name: Generate Documentation with pdoc
        run: |
          source .venv/bin/activate
          pdoc --html --output-dir docs .  # Génère la documentation dans le répertoire 'docs'

      # Étape 9: Déployer la documentation sur GitHub Pages
      - name: Deploy Documentation to GitHub Pages
        if: github.ref == 'refs/heads/main'  # Déploie uniquement sur la branche 'main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          folder: docs  # Déployer les fichiers générés dans le dossier 'docs'
          target_branch: gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
